<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALTA CAL Invoice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            padding: 15px;
            background-color: #f5f5f5;
            font-size: 14px;
        }

        .container {
            background: white;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 15px;
            font-size: 24px;
            color: #1976D2;
        }

        .top-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .header-box {
            background: #000;
            color: white;
            padding: 12px;
        }

        .header-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 8px;
        }

        .header-row:last-child {
            margin-bottom: 0;
        }

        .field {
            display: flex;
            flex-direction: column;
        }

        .field label {
            font-size: 11px;
            margin-bottom: 4px;
            font-weight: bold;
        }

        .field input {
            padding: 8px;
            border: 2px solid #000;
            font-size: 14px;
        }
        
        .field input[type="number"] {
            padding-left: 20px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .left-side, .right-side {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section {
            background: #f8f8f8;
            border: 2px solid #000;
            padding: 12px;
        }

        .section-title {
            background: #333;
            color: white;
            padding: 8px 12px;
            margin: -12px -12px 12px -12px;
            font-weight: bold;
            font-size: 13px;
            border-bottom: 2px solid #000;
        }

        .par-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .par-btn {
            padding: 10px;
            border: 2px solid #000;
            background: #e0e0e0;
            color: #000;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .par-btn:hover {
            background: #d0d0d0;
        }

        .par-btn.active {
            background: #FF9800;
            color: white;
            border-color: #FF9800;
        }

        .par-fields {
            display: none;
            background: #fff3e0;
            border: 2px solid #FF9800;
            padding: 12px;
            margin-bottom: 12px;
        }

        .par-fields.active {
            display: block;
        }

        .par-fields-title {
            font-weight: bold;
            font-size: 12px;
            margin-bottom: 8px;
            color: #FF9800;
        }

        .par-input-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .par-addon-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 6px;
            margin-bottom: 6px;
            align-items: end;
        }

        .par-addon-row input,
        .par-addon-row select {
            padding: 6px 8px;
            border: 2px solid #FF9800;
            font-size: 12px;
        }

        .par-addon-row select {
            padding-left: 8px;
        }

        .par-addon-row input[type="number"] {
            padding-left: 20px;
        }

        .par-coating-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 6px;
            margin-bottom: 6px;
            align-items: end;
        }

        .par-coating-row select,
        .par-coating-row input {
            padding: 6px 8px;
            border: 2px solid #FF9800;
            font-size: 12px;
        }

        .par-coating-row input[type="number"] {
            padding-left: 20px;
        }

        .par-coating-row .calc-display {
            background: #fff3e0;
            border: 2px solid #FF9800;
            padding: 6px 8px;
            font-weight: bold;
            text-align: center;
            font-size: 12px;
        }

        .custom-fields {
            display: none;
            grid-column: 1 / -1;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 6px;
            margin-top: 6px;
        }

        .custom-fields.active {
            display: grid;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 8px;
            font-size: 13px;
        }

        thead {
            background: #000;
            color: white;
        }

        th {
            padding: 8px;
            text-align: left;
            font-size: 12px;
            border: 2px solid #000;
        }

        td {
            padding: 6px;
            border: 2px solid #000;
        }

        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        input[type="text"].table-input,
        input[type="number"].table-input {
            width: 100%;
            padding: 6px 8px;
            border: 2px solid #000;
            font-size: 13px;
        }
        
        input[type="number"].table-input {
            padding-left: 20px;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .add-btn {
            width: 100%;
            padding: 8px;
            background: #4CAF50;
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
            font-weight: bold;
        }

        .add-btn:hover {
            background: #45a049;
        }

        .calc-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .calc-box {
            background: white;
            padding: 10px;
            border: 2px solid #000;
            text-align: center;
        }

        .calc-box.highlight {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .calc-box.info {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        .calc-box.warning {
            background: #FF9800;
            color: white;
            border-color: #FF9800;
        }

        .calc-label {
            font-size: 9px;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .calc-value {
            font-size: 16px;
            font-weight: bold;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }

        .name-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 8px;
        }

        .payout-label {
            display: none;
        }

        .name-row {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .name-input {
            padding: 6px 8px;
            border: 2px solid #000;
            font-size: 13px;
        }

        .name-amount {
            background: #4CAF50;
            color: white;
            padding: 6px 12px;
            font-weight: bold;
            font-size: 14px;
            min-width: 80px;
            text-align: center;
            border: 2px solid #000;
        }

        .initial-boxes {
            display: none;
        }

        .button-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .action-btn {
            padding: 12px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
        }

        .calculation-breakdown {
            display: none;
        }

        .print-btn {
            background: #2196F3;
            color: white;
        }

        .new-file-btn {
            background: #4CAF50;
            color: white;
        }

        @media print {
            body {
                padding: 0;
                background: white;
                font-size: 13px;
                color: black !important;
            }
            * {
                color: black !important;
            }
            .container {
                padding: 8px;
                max-width: 100%;
            }
            h1 {
                font-size: 18px;
                margin-bottom: 8px;
                color: black !important;
            }
            .top-section {
                gap: 8px;
                margin-bottom: 8px;
            }
            .header-box {
                padding: 8px;
                background: white !important;
                border: none !important;
            }
            .header-row {
                gap: 6px;
                margin-bottom: 5px;
            }
            .field label {
                font-size: 9px;
                margin-bottom: 2px;
                color: black !important;
            }
            .field input {
                padding: 5px;
                font-size: 11px;
                color: black !important;
                border: 1px solid black !important;
            }
            .main-grid {
                gap: 8px;
                margin-bottom: 8px;
            }
            .left-side, .right-side {
                gap: 8px;
            }
            .section {
                padding: 8px;
                border: 2px solid black !important;
                background: white !important;
            }
            .section-title {
                padding: 5px 8px;
                margin: -8px -8px 8px -8px;
                font-size: 13px;
                background: white !important;
                color: black !important;
                border-bottom: 2px solid black !important;
            }
            .par-buttons {
                display: none;
            }
            .par-fields {
                background: white !important;
                border: 2px solid black !important;
                padding: 8px !important;
                margin-bottom: 8px !important;
                page-break-inside: avoid;
            }
            .par-fields.active {
                display: block !important;
            }
            .par-fields-title {
                font-size: 11px !important;
                margin-bottom: 6px !important;
                color: black !important;
                font-weight: bold !important;
            }
            .par-input-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 6px !important;
            }
            .par-addon-row {
                gap: 4px !important;
                margin-bottom: 4px !important;
                grid-template-columns: 2fr 1fr 1fr 1fr !important;
            }
            .par-addon-row button {
                display: none !important;
            }
            .par-addon-row input,
            .par-addon-row select {
                padding: 4px 6px !important;
                font-size: 10px !important;
                border: 1px solid black !important;
                color: black !important;
            }
            .par-coating-row {
                display: grid !important;
                grid-template-columns: 2fr 1fr 1fr 1fr !important;
                gap: 4px !important;
                margin-bottom: 4px !important;
            }
            .par-coating-row button {
                display: none !important;
            }
            .par-coating-row select,
            .par-coating-row input {
                padding: 4px 6px !important;
                font-size: 10px !important;
                border: 1px solid black !important;
                color: black !important;
            }
            .par-coating-row .calc-display {
                padding: 4px 6px !important;
                font-size: 10px !important;
                border: 1px solid black !important;
                color: black !important;
                background: white !important;
                text-align: center !important;
            }
            .custom-fields {
                display: grid !important;
                grid-template-columns: 2fr 1fr 1fr 1fr !important;
                gap: 4px !important;
                margin-bottom: 4px !important;
            }
            .custom-fields button {
                display: none !important;
            }
            .custom-fields.active {
                display: grid !important;
            }
            .custom-fields input {
                padding: 4px 6px !important;
                font-size: 10px !important;
                border: 1px solid black !important;
                color: black !important;
            }
            .custom-fields .calc-display {
                padding: 4px 6px !important;
                font-size: 10px !important;
                border: 1px solid black !important;
                color: black !important;
                background: white !important;
                text-align: center !important;
            }
            #parAddOnsList:empty + button {
                display: none !important;
            }
            #parAddOnsList:empty::before {
                display: none !important;
            }
            .par-addon-section {
                display: none;
            }
            .par-addon-section:has(.par-addon-row) {
                display: block !important;
            }
            #parAddOnsTitle {
                display: none !important;
            }
            #parAddOnsList:not(:empty) ~ #parAddOnsTitle,
            #parAddOnsList .par-addon-row ~ #parAddOnsTitle {
                display: none !important;
            }
            #parAddOnsSection:has(.par-addon-row) #parAddOnsTitle {
                display: block !important;
                color: black !important;
            }
            table {
                margin-bottom: 6px;
                font-size: 10px;
            }
            th {
                padding: 5px;
                font-size: 10px;
                background: white !important;
                color: black !important;
                border: 1px solid black !important;
            }
            td {
                padding: 4px;
                border: 1px solid black !important;
                color: black !important;
            }
            input[type="text"].table-input,
            input[type="number"].table-input {
                padding: 4px 5px;
                font-size: 10px;
                color: black !important;
                border: 1px solid black !important;
            }
            input[type="checkbox"] {
                width: 14px;
                height: 14px;
            }
            .calc-grid {
                gap: 6px;
                display: grid;
                grid-template-columns: repeat(3, 1fr);
            }
            .calc-box {
                padding: 8px;
                background: white !important;
                border: 2px solid black !important;
            }
            .calc-label {
                font-size: 8px;
                margin-bottom: 3px;
                color: black !important;
            }
            .calc-value {
                font-size: 14px;
                color: black !important;
            }
            .input-grid {
                gap: 6px;
                margin-bottom: 6px;
            }
            .name-list {
                gap: 5px;
                margin-top: 5px;
            }
            
            .payout-label {
                display: block !important;
                font-size: 13px !important;
                font-weight: bold !important;
                color: black !important;
                background: white !important;
                border: 2px solid black !important;
                padding: 6px 10px;
                margin-bottom: 6px;
                text-align: center;
            }
            
            .name-row {
                display: grid !important;
                grid-template-columns: 2.4fr 1.2fr 0.7fr 0.7fr;
                gap: 6px;
                align-items: center;
                margin-bottom: 8px;
            }
            
            .name-input {
                padding: 6px 10px !important;
                font-size: 20px !important;
                font-weight: bold !important;
                color: black !important;
                border: 2px solid black !important;
                box-sizing: border-box !important;
            }
            .name-amount {
                padding: 8px 4px !important;
                font-size: 16px !important;
                font-weight: bold !important;
                background: white !important;
                color: black !important;
                border: 2px solid black !important;
                text-align: center !important;
                box-sizing: border-box !important;
                overflow: hidden !important;
                white-space: nowrap !important;
            }
            .initial-boxes {
                display: contents !important;
            }
            .initial-box {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 2px;
            }
            .initial-box-square {
                width: 42px !important;
                height: 42px !important;
                border: 2px solid black !important;
                background: white !important;
            }
            .initial-box-label {
                font-size: 6px !important;
                color: black !important;
                text-align: center !important;
                font-weight: bold !important;
                line-height: 1.1 !important;
                max-width: 42px;
            }
            .button-section, .add-btn {
                display: none;
            }
            .calculation-breakdown {
                display: block !important;
                page-break-before: always;
                padding: 30px !important;
                background: white !important;
            }
            .breakdown-title {
                font-size: 20px !important;
                font-weight: bold !important;
                text-align: center !important;
                margin-bottom: 20px !important;
                padding: 15px !important;
                border: 3px solid black !important;
                background: white !important;
                color: black !important;
            }
            .breakdown-section {
                margin-bottom: 20px !important;
                padding: 15px !important;
                border: 2px solid black !important;
                background: white !important;
            }
            .breakdown-section-title {
                font-size: 15px !important;
                font-weight: bold !important;
                margin-bottom: 12px !important;
                color: black !important;
                text-decoration: underline;
            }
            .breakdown-line {
                display: flex !important;
                justify-content: space-between !important;
                padding: 5px 0 !important;
                font-size: 13px !important;
                color: black !important;
            }
            .breakdown-line.total {
                font-weight: bold !important;
                border-top: 2px solid black !important;
                margin-top: 8px !important;
                padding-top: 8px !important;
                font-size: 14px !important;
            }
            @page {
                margin: 0.4in 0.35in;
                size: letter;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ALTA CAL - INVOICE SHEET</h1>

        <div class="top-section">
            <div class="header-box">
                <div class="header-row" style="grid-template-columns: 1fr;">
                    <div class="field">
                        <label>CUSTOMER NAME</label>
                        <input type="text" id="customerName">
                    </div>
                </div>
                <div class="header-row">
                    <div class="field">
                        <label>JOB NUMBER</label>
                        <input type="text" id="jobNumber">
                    </div>
                    <div class="field">
                        <label>FULL AMOUNT OF MONEY IN BANK DATE</label>
                        <input type="date" id="moneyInBank">
                    </div>
                </div>
                <div class="header-row">
                    <div class="field">
                        <label>CONTRACT AMOUNT</label>
                        <input type="number" id="contractAmount" step="0.01" inputmode="decimal" style="padding-left: 20px;">
                    </div>
                    <div class="field">
                        <label>NET AMOUNT</label>
                        <input type="number" id="netAmount" step="0.01" inputmode="decimal" style="padding-left: 20px;">
                    </div>
                </div>
            </div>

            <div class="header-box">
                <div class="calc-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="calc-box warning">
                        <div class="calc-label">HOUSE FEE %</div>
                        <div class="calc-value" id="houseFeePercent">0%</div>
                    </div>
                    <div class="calc-box info">
                        <div class="calc-label">TOTAL JOB COST</div>
                        <div class="calc-value" id="totalJobCost">$0</div>
                    </div>
                    <div class="calc-box info">
                        <div class="calc-label">AFTER FEES</div>
                        <div class="calc-value" id="totalAfterFees">$0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <div class="left-side">
                <!-- INVOICE TABLE -->
                <div class="section">
                    <div class="section-title">INVOICE ITEMS</div>
                    <table id="invoiceTable">
                        <thead>
                            <tr>
                                <th style="width: 50%;">LABOR & MATERIAL</th>
                                <th style="width: 30%;">COST</th>
                                <th style="width: 20%;">PAID</th>
                            </tr>
                        </thead>
                        <tbody id="invoiceTableBody"></tbody>
                    </table>
                    <button class="add-btn" onclick="addInvoiceRow()">+ ADD ROW</button>
                </div>

                <!-- FEES & BONUSES -->
                <div class="section">
                    <div class="section-title">FEES & BONUSES</div>
                    <div class="input-grid">
                        <div class="field">
                            <label>RIDE ALONG FEE/ADDITIONAL FEES</label>
                            <input type="number" id="rideAlongFee" step="0.01" inputmode="decimal" style="padding-left: 20px;">
                        </div>
                        <div class="field">
                            <label>RIDE ALONG BONUS</label>
                            <input type="number" id="rideAlongBonus" step="0.01" inputmode="decimal" style="padding-left: 20px;">
                        </div>
                        <div class="calc-box">
                            <div class="calc-label">FEE PER PERSON</div>
                            <div class="calc-value" id="rideAlongFeePerPerson">$0</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-side">
                <!-- VETS -->
                <div class="section">
                    <div class="section-title">PROJECTED VET PAYOUTS</div>
                    <div class="input-grid">
                        <div class="field">
                            <label>NUMBER OF VETS</label>
                            <input type="number" id="numVets" step="1" inputmode="numeric">
                        </div>
                        <div class="calc-box warning" id="vetRateBox" style="display: none;">
                            <div class="calc-label">RATE</div>
                            <div class="calc-value" id="vetRate">25%</div>
                        </div>
                        <div class="calc-box highlight" id="vetPayoutBox" style="display: none;">
                            <div class="calc-label">PER VET</div>
                            <div class="calc-value" id="finalPerVet">$0</div>
                        </div>
                    </div>
                    <div id="vetNamesList" class="name-list"></div>
                </div>

                <!-- REPS -->
                <div class="section">
                    <div class="section-title">PROJECTED REP PAYOUTS</div>
                    
                    <!-- PAR BUTTONS -->
                    <div class="par-buttons">
                        <button class="par-btn" id="parGuttersBtn" onclick="togglePAR('gutters')">PAR GUTTERS</button>
                        <button class="par-btn" id="parInsulationBtn" onclick="togglePAR('insulation')">PAR INSULATION</button>
                        <button class="par-btn" id="parCoatingBtn" onclick="togglePAR('coating')">PAR COATING</button>
                    </div>

                    <!-- PAR GUTTERS FIELDS -->
                    <div class="par-fields" id="parGuttersFields">
                        <div class="par-fields-title">PAR GUTTERS CALCULATION</div>
                        <div class="par-input-grid">
                            <div class="field">
                                <label>GUTTERS (Linear Feet) @ $27/lf</label>
                                <input type="number" id="guttersLF" step="0.01" inputmode="decimal" style="padding-left: 20px;">
                            </div>
                            <div class="field">
                                <label>ADDITIONAL WOOD (Linear Feet) @ $17/lf</label>
                                <input type="number" id="woodLF" step="0.01" inputmode="decimal" style="padding-left: 20px;">
                            </div>
                        </div>
                        
                        <!-- PAR ADD-ONS -->
                        <div id="parAddOnsSection" style="margin-top: 12px;">
                            <div id="parAddOnsTitle" style="font-weight: bold; font-size: 11px; margin-bottom: 8px; color: #FF9800; display: none;">PAR ADD-ONS</div>
                            <div id="parAddOnsList"></div>
                            <button class="add-btn" onclick="addParAddOn()" style="margin-top: 8px;">+ ADD PAR LINE ITEM</button>
                        </div>
                        
                        <div class="calc-box warning" style="margin-top: 12px;">
                            <div class="calc-label">TOTAL PAR AMOUNT</div>
                            <div class="calc-value" id="parGuttersAmount">$0</div>
                        </div>
                    </div>

                    <!-- PAR INSULATION FIELDS (placeholder for future) -->
                    <div class="par-fields" id="parInsulationFields">
                        <div class="par-fields-title">PAR INSULATION CALCULATION</div>
                        <div class="par-input-grid">
                            <div class="field">
                                <label>INSULATION (Square Feet) @ $4/sf</label>
                                <input type="number" id="insulationSF" step="0.01" inputmode="decimal" style="padding-left: 20px;">
                            </div>
                            <div class="field">
                                <label>ADDITIONAL WOOD (Linear Feet) @ $17/lf</label>
                                <input type="number" id="insulationWoodLF" step="0.01" inputmode="decimal" style="padding-left: 20px;">
                            </div>
                        </div>
                        
                        <!-- PAR ADD-ONS FOR INSULATION -->
                        <div id="parInsulationAddOnsSection" style="margin-top: 12px;">
                            <div id="parInsulationAddOnsTitle" style="font-weight: bold; font-size: 11px; margin-bottom: 8px; color: #FF9800; display: none;">PAR ADD-ONS</div>
                            <div id="parInsulationAddOnsList"></div>
                            <button class="add-btn" onclick="addParInsulationAddOn()" style="margin-top: 8px;">+ ADD PAR LINE ITEM</button>
                        </div>
                        
                        <div class="calc-box warning" style="margin-top: 12px;">
                            <div class="calc-label">TOTAL PAR AMOUNT</div>
                            <div class="calc-value" id="parInsulationAmount">$0</div>
                        </div>
                    </div>

                    <!-- PAR COATING FIELDS -->
                    <div class="par-fields" id="parCoatingFields">
                        <div class="par-fields-title">PAR COATING CALCULATION</div>
                        
                        <!-- COATING PRODUCTS -->
                        <div id="parCoatingProductsSection">
                            <div id="parCoatingProductsList"></div>
                            <button class="add-btn" onclick="addParCoatingProduct()" style="margin-top: 8px;">+ ADD PRODUCT</button>
                        </div>
                        
                        <div class="calc-box warning" style="margin-top: 12px;">
                            <div class="calc-label">TOTAL PAR AMOUNT</div>
                            <div class="calc-value" id="parCoatingAmount">$0</div>
                        </div>
                    </div>

                    <div class="input-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="field">
                            <label>NUMBER OF REPS</label>
                            <input type="number" id="numReps" step="1" inputmode="numeric">
                        </div>
                        <div class="calc-box warning" id="repRateBox" style="display: none;">
                            <div class="calc-label">RATE</div>
                            <div class="calc-value" id="repRate">20%</div>
                        </div>
                    </div>
                    <span id="finalPerRep" style="display: none;">$0</span>
                    <div id="repNamesList" class="name-list"></div>
                </div>

                <!-- RIDE ALONGS -->
                <div class="section">
                    <div class="section-title">RIDE ALONG PAYOUTS</div>
                    <div class="input-grid">
                        <div class="field">
                            <label>NUMBER OF RIDE ALONGS</label>
                            <input type="number" id="numRideAlongs" step="1" inputmode="numeric">
                        </div>
                        <div class="calc-box highlight">
                            <div class="calc-label">PER RIDE ALONG</div>
                            <div class="calc-value" id="perRideAlong">$0</div>
                        </div>
                        <div class="calc-box highlight">
                            <div class="calc-label">TOTAL RA PAYOUT</div>
                            <div class="calc-value" id="totalRideAlongPayout">$0</div>
                        </div>
                    </div>
                    <div id="rideAlongNamesList" class="name-list"></div>
                </div>
            </div>
        </div>

        <!-- CALCULATION BREAKDOWN (Print Only) -->
        <div class="calculation-breakdown">
            <div class="breakdown-title">CALCULATION BREAKDOWN</div>
            <div id="breakdownContent"></div>
        </div>

        <div class="button-section">
            <button class="action-btn print-btn" onclick="printInvoice()">üñ®Ô∏è PRINT</button>
            <button class="action-btn new-file-btn" onclick="addNewFile()">+ NEW FILE</button>
        </div>
    </div>

    <script>
        let activePAR = null; // Track which PAR system is active: 'gutters', 'insulation', 'coating', or null

        function addParAddOn() {
            const container = document.getElementById('parAddOnsList');
            const title = document.getElementById('parAddOnsTitle');
            const row = document.createElement('div');
            row.className = 'par-addon-row';
            
            row.innerHTML = `
                <input type="text" placeholder="Item Name" onchange="updateCalculations()">
                <input type="number" placeholder="Quantity" step="0.01" inputmode="decimal" onchange="updateCalculations()" style="padding-left: 20px;">
                <select onchange="updateCalculations()">
                    <option value="lf">ln ft</option>
                    <option value="sf">sq ft</option>
                </select>
                <input type="number" placeholder="Rate ($)" step="0.01" inputmode="decimal" onchange="updateCalculations()" style="padding-left: 20px;">
                <button onclick="deleteParAddOn(this)" style="padding: 6px 10px; background: #f44336; color: white; border: none; cursor: pointer; font-size: 11px;">‚úï</button>
            `;
            
            container.appendChild(row);
            
            // Show title when there are add-ons
            if (container.children.length > 0) {
                title.style.display = 'block';
            }
            
            updateCalculations();
        }

        function deleteParAddOn(btn) {
            const row = btn.closest('.par-addon-row');
            const container = document.getElementById('parAddOnsList');
            const title = document.getElementById('parAddOnsTitle');
            
            if (row) {
                row.remove();
                
                // Hide title if no more add-ons
                if (container.children.length === 0) {
                    title.style.display = 'none';
                }
                
                updateCalculations();
            }
        }

        function addParInsulationAddOn() {
            const container = document.getElementById('parInsulationAddOnsList');
            const title = document.getElementById('parInsulationAddOnsTitle');
            const row = document.createElement('div');
            row.className = 'par-addon-row';
            
            row.innerHTML = `
                <input type="text" placeholder="Item Name" onchange="updateCalculations()">
                <input type="number" placeholder="Quantity" step="0.01" inputmode="decimal" onchange="updateCalculations()" style="padding-left: 20px;">
                <select onchange="updateCalculations()">
                    <option value="lf">ln ft</option>
                    <option value="sf">sq ft</option>
                </select>
                <input type="number" placeholder="Rate ($)" step="0.01" inputmode="decimal" onchange="updateCalculations()" style="padding-left: 20px;">
                <button onclick="deleteParInsulationAddOn(this)" style="padding: 6px 10px; background: #f44336; color: white; border: none; cursor: pointer; font-size: 11px;">‚úï</button>
            `;
            
            container.appendChild(row);
            
            // Show title when there are add-ons
            if (container.children.length > 0) {
                title.style.display = 'block';
            }
            
            updateCalculations();
        }

        function deleteParInsulationAddOn(btn) {
            const row = btn.closest('.par-addon-row');
            const container = document.getElementById('parInsulationAddOnsList');
            const title = document.getElementById('parInsulationAddOnsTitle');
            
            if (row) {
                row.remove();
                
                // Hide title if no more add-ons
                if (container.children.length === 0) {
                    title.style.display = 'none';
                }
                
                updateCalculations();
            }
        }

        function addParCoatingProduct() {
            const container = document.getElementById('parCoatingProductsList');
            const row = document.createElement('div');
            row.className = 'par-coating-row';
            
            row.innerHTML = `
                <select onchange="handleCoatingProductChange(this)">
                    <option value="">Select Product</option>
                    <option value="square_count|675">Square Count - $675/sq</option>
                    <option value="windows|215">Windows/Reglaze/Paint (Wood/Steel) - $215 ea</option>
                    <option value="security_door|375">Security Door - $375 ea</option>
                    <option value="burglar_bars|200">Burglar Bars - $200 ea</option>
                    <option value="awning_under3|250">Metal Awning Under 3 feet - $250 ea</option>
                    <option value="awning_over3|325">Metal Awning Over 3 feet - $325 ea</option>
                    <option value="spanish_lace|245">Spanish Lace - $245/sq</option>
                    <option value="wood_replacement|17">Wood Replacement (eave/fascia) - $17/ln ft</option>
                    <option value="wood_repairs|750">Wood Repairs (siding) - $750/sq</option>
                    <option value="wood_siding|350">Wood Siding/Eave strip bare wood - $350/sq</option>
                    <option value="one_float|200">One Float - $200/sq</option>
                    <option value="two_float|450">Two Float - $450/sq</option>
                    <option value="lath_paper|1250">Lath paper three float - $1,250/sq</option>
                    <option value="structural_crack|225">Structural crack - $225 ea</option>
                    <option value="remove_patio|250">Remove & haul away patio overhang - $250</option>
                    <option value="door|250">Door - $250 ea</option>
                    <option value="custom|0">ADDITIONAL CHARGE (Custom)</option>
                </select>
                <input type="number" class="qty-input" placeholder="Qty" step="0.01" inputmode="decimal" onchange="updateCalculations()" style="padding-left: 20px;">
                <input type="text" class="rate-display" readonly placeholder="Rate" style="background: #f0f0f0;">
                <div class="calc-display">$0.00</div>
                <button onclick="deleteCoatingProduct(this)" style="padding: 6px 10px; background: #f44336; color: white; border: none; cursor: pointer; font-size: 11px;">‚úï</button>
            `;
            
            // Add custom fields container (hidden by default)
            const customContainer = document.createElement('div');
            customContainer.className = 'custom-fields';
            customContainer.innerHTML = `
                <input type="text" placeholder="Custom Product Name" onchange="updateCalculations()">
                <input type="number" placeholder="Quantity" step="0.01" inputmode="decimal" onchange="updateCalculations()" style="padding-left: 20px;">
                <input type="number" placeholder="Rate ($)" step="0.01" inputmode="decimal" onchange="updateCalculations()" style="padding-left: 20px;">
                <div class="calc-display">$0.00</div>
                <button onclick="deleteCoatingProduct(this)" style="padding: 6px 10px; background: #f44336; color: white; border: none; cursor: pointer; font-size: 11px;">‚úï</button>
            `;
            
            container.appendChild(row);
            container.appendChild(customContainer);
            
            updateCalculations();
        }

        function deleteCoatingProduct(btn) {
            const row = btn.closest('.par-coating-row') || btn.closest('.custom-fields');
            if (row) {
                // If it's a regular row, also remove the associated custom fields
                if (row.classList.contains('par-coating-row')) {
                    const customFields = row.nextElementSibling;
                    if (customFields && customFields.classList.contains('custom-fields')) {
                        customFields.remove();
                    }
                } else if (row.classList.contains('custom-fields')) {
                    // If deleting custom fields, also remove the associated regular row
                    const regularRow = row.previousElementSibling;
                    if (regularRow && regularRow.classList.contains('par-coating-row')) {
                        regularRow.remove();
                    }
                }
                row.remove();
                updateCalculations();
            }
        }

        function handleCoatingProductChange(selectElement) {
            const row = selectElement.closest('.par-coating-row');
            const customFields = row.nextElementSibling;
            const value = selectElement.value;
            
            if (value === 'custom|0') {
                // Show custom fields
                customFields.classList.add('active');
                row.style.display = 'none';
            } else if (value) {
                // Hide custom fields and update rate
                customFields.classList.remove('active');
                row.style.display = 'grid';
                
                const [productKey, rate] = value.split('|');
                const rateDisplay = row.querySelector('.rate-display');
                rateDisplay.value = '$' + parseFloat(rate).toFixed(2);
            } else {
                customFields.classList.remove('active');
                row.style.display = 'grid';
                const rateDisplay = row.querySelector('.rate-display');
                rateDisplay.value = '';
            }
            
            updateCalculations();
        }

        function togglePAR(parType) {
            // If clicking the same button, deactivate PAR
            if (activePAR === parType) {
                activePAR = null;
                document.getElementById('parGuttersBtn').classList.remove('active');
                document.getElementById('parInsulationBtn').classList.remove('active');
                document.getElementById('parCoatingBtn').classList.remove('active');
                document.getElementById('parGuttersFields').classList.remove('active');
                document.getElementById('parInsulationFields').classList.remove('active');
                document.getElementById('parCoatingFields').classList.remove('active');
            } else {
                // Activate the selected PAR type
                activePAR = parType;
                
                // Remove all active states
                document.getElementById('parGuttersBtn').classList.remove('active');
                document.getElementById('parInsulationBtn').classList.remove('active');
                document.getElementById('parCoatingBtn').classList.remove('active');
                document.getElementById('parGuttersFields').classList.remove('active');
                document.getElementById('parInsulationFields').classList.remove('active');
                document.getElementById('parCoatingFields').classList.remove('active');
                
                // Add active state to selected button and fields
                if (parType === 'gutters') {
                    document.getElementById('parGuttersBtn').classList.add('active');
                    document.getElementById('parGuttersFields').classList.add('active');
                } else if (parType === 'insulation') {
                    document.getElementById('parInsulationBtn').classList.add('active');
                    document.getElementById('parInsulationFields').classList.add('active');
                } else if (parType === 'coating') {
                    document.getElementById('parCoatingBtn').classList.add('active');
                    document.getElementById('parCoatingFields').classList.add('active');
                }
            }
            
            updateCalculations();
        }

        function initializeTable() {
            for (let i = 0; i < 5; i++) {
                addInvoiceRow();
            }
            updateCalculations();
        }

        function addInvoiceRow() {
            const tbody = document.getElementById('invoiceTableBody');
            const row = tbody.insertRow();
            
            const cell1 = row.insertCell(0);
            const cell2 = row.insertCell(1);
            const cell3 = row.insertCell(2);

            cell1.innerHTML = '<input type="text" class="table-input" placeholder="Item" onchange="saveData()">';
            cell2.innerHTML = '<input type="number" class="table-input" step="0.01" inputmode="decimal" onchange="updateCalculations()" style="padding-left: 20px;">';
            cell3.innerHTML = '<input type="checkbox" onchange="saveData()">';

            saveData();
        }

        function updateNameFields() {
            const numVets = parseInt(document.getElementById('numVets').value) || 0;
            const numReps = parseInt(document.getElementById('numReps').value) || 0;
            const numRideAlongs = parseInt(document.getElementById('numRideAlongs').value) || 0;

            // Get current payout amounts
            const finalPerVet = document.getElementById('finalPerVet').textContent;
            const finalPerRep = document.getElementById('finalPerRep').textContent;
            const perRideAlong = document.getElementById('perRideAlong').textContent;

            // Update vet names
            const vetList = document.getElementById('vetNamesList');
            const currentVetNames = Array.from(vetList.querySelectorAll('input')).map(i => i.value);
            vetList.innerHTML = '';
            
            // Add VETS label
            if (numVets > 0) {
                const vetLabel = document.createElement('div');
                vetLabel.className = 'payout-label';
                vetLabel.textContent = 'VETS';
                vetList.appendChild(vetLabel);
            }
            
            for (let i = 0; i < numVets; i++) {
                const row = document.createElement('div');
                row.className = 'name-row';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'name-input';
                input.placeholder = `Vet ${i + 1} Name`;
                input.value = currentVetNames[i] || '';
                input.onchange = saveData;
                
                const amount = document.createElement('div');
                amount.className = 'name-amount';
                amount.textContent = finalPerVet;
                
                // Create initial boxes container
                const initialBoxes = document.createElement('div');
                initialBoxes.className = 'initial-boxes';
                
                // First initial box (for the person)
                const personBox = document.createElement('div');
                personBox.className = 'initial-box';
                const personSquare = document.createElement('div');
                personSquare.className = 'initial-box-square';
                const personLabel = document.createElement('div');
                personLabel.className = 'initial-box-label';
                personLabel.textContent = 'INITIAL';
                personBox.appendChild(personSquare);
                personBox.appendChild(personLabel);
                
                // Second initial box (for Ryan A/Juan E)
                const approvalBox = document.createElement('div');
                approvalBox.className = 'initial-box';
                const approvalSquare = document.createElement('div');
                approvalSquare.className = 'initial-box-square';
                const approvalLabel = document.createElement('div');
                approvalLabel.className = 'initial-box-label';
                approvalLabel.textContent = 'RYAN A/ JUAN E APPROVED';
                approvalBox.appendChild(approvalSquare);
                approvalBox.appendChild(approvalLabel);
                
                initialBoxes.appendChild(personBox);
                initialBoxes.appendChild(approvalBox);
                
                row.appendChild(input);
                row.appendChild(amount);
                row.appendChild(initialBoxes);
                vetList.appendChild(row);
            }

            // Update rep names
            const repList = document.getElementById('repNamesList');
            const currentRepNames = Array.from(repList.querySelectorAll('input')).map(i => i.value);
            repList.innerHTML = '';
            
            // Add REPS label
            if (numReps > 0) {
                const repLabel = document.createElement('div');
                repLabel.className = 'payout-label';
                repLabel.textContent = 'REPS';
                repList.appendChild(repLabel);
            }
            
            for (let i = 0; i < numReps; i++) {
                const row = document.createElement('div');
                row.className = 'name-row';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'name-input';
                input.placeholder = `Rep ${i + 1} Name`;
                input.value = currentRepNames[i] || '';
                input.onchange = saveData;
                
                const amount = document.createElement('div');
                amount.className = 'name-amount';
                amount.textContent = finalPerRep;
                
                // Create initial boxes container
                const initialBoxes = document.createElement('div');
                initialBoxes.className = 'initial-boxes';
                
                // First initial box (for the person)
                const personBox = document.createElement('div');
                personBox.className = 'initial-box';
                const personSquare = document.createElement('div');
                personSquare.className = 'initial-box-square';
                const personLabel = document.createElement('div');
                personLabel.className = 'initial-box-label';
                personLabel.textContent = 'INITIAL';
                personBox.appendChild(personSquare);
                personBox.appendChild(personLabel);
                
                // Second initial box (for Ryan A/Juan E)
                const approvalBox = document.createElement('div');
                approvalBox.className = 'initial-box';
                const approvalSquare = document.createElement('div');
                approvalSquare.className = 'initial-box-square';
                const approvalLabel = document.createElement('div');
                approvalLabel.className = 'initial-box-label';
                approvalLabel.textContent = 'RYAN A/ JUAN E APPROVED';
                approvalBox.appendChild(approvalSquare);
                approvalBox.appendChild(approvalLabel);
                
                initialBoxes.appendChild(personBox);
                initialBoxes.appendChild(approvalBox);
                
                row.appendChild(input);
                row.appendChild(amount);
                row.appendChild(initialBoxes);
                repList.appendChild(row);
            }

            // Update ride along names
            const raList = document.getElementById('rideAlongNamesList');
            const currentRANames = Array.from(raList.querySelectorAll('input')).map(i => i.value);
            raList.innerHTML = '';
            
            // Add R/A label
            if (numRideAlongs > 0) {
                const raLabel = document.createElement('div');
                raLabel.className = 'payout-label';
                raLabel.textContent = 'R/A';
                raList.appendChild(raLabel);
            }
            
            for (let i = 0; i < numRideAlongs; i++) {
                const row = document.createElement('div');
                row.className = 'name-row';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'name-input';
                input.placeholder = `Ride Along ${i + 1} Name`;
                input.value = currentRANames[i] || '';
                input.onchange = saveData;
                
                const amount = document.createElement('div');
                amount.className = 'name-amount';
                amount.textContent = perRideAlong;
                
                // Create initial boxes container
                const initialBoxes = document.createElement('div');
                initialBoxes.className = 'initial-boxes';
                
                // First initial box (for the person)
                const personBox = document.createElement('div');
                personBox.className = 'initial-box';
                const personSquare = document.createElement('div');
                personSquare.className = 'initial-box-square';
                const personLabel = document.createElement('div');
                personLabel.className = 'initial-box-label';
                personLabel.textContent = 'INITIAL';
                personBox.appendChild(personSquare);
                personBox.appendChild(personLabel);
                
                // Second initial box (for Ryan A/Juan E)
                const approvalBox = document.createElement('div');
                approvalBox.className = 'initial-box';
                const approvalSquare = document.createElement('div');
                approvalSquare.className = 'initial-box-square';
                const approvalLabel = document.createElement('div');
                approvalLabel.className = 'initial-box-label';
                approvalLabel.textContent = 'RYAN A/ JUAN E APPROVED';
                approvalBox.appendChild(approvalSquare);
                approvalBox.appendChild(approvalLabel);
                
                initialBoxes.appendChild(personBox);
                initialBoxes.appendChild(approvalBox);
                
                row.appendChild(input);
                row.appendChild(amount);
                row.appendChild(initialBoxes);
                raList.appendChild(row);
            }
        }

        function parseValue(value) {
            if (value === null || value === undefined || value === '') return 0;
            const parsed = parseFloat(value.toString().replace(/[,$]/g, ''));
            return isNaN(parsed) ? 0 : parsed;
        }

        function formatCurrency(value) {
            if (isNaN(value)) return '$0.00';
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(value);
        }

        function updateCalculations() {
            const contractAmount = parseValue(document.getElementById('contractAmount').value);
            const netAmount = parseValue(document.getElementById('netAmount').value);
            const rideAlongFee = parseValue(document.getElementById('rideAlongFee').value);
            const rideAlongBonus = parseValue(document.getElementById('rideAlongBonus').value);
            const numVets = parseValue(document.getElementById('numVets').value);
            const numReps = parseValue(document.getElementById('numReps').value);
            const numRideAlongs = parseValue(document.getElementById('numRideAlongs').value);

            // House fee tiers
            let houseFeePercent = 0;
            if (contractAmount <= 20000) houseFeePercent = 10;
            else if (contractAmount <= 30000) houseFeePercent = 9;
            else houseFeePercent = 8;
            
            document.getElementById('houseFeePercent').textContent = houseFeePercent + '%';

            // Calculate costs
            const rows = document.getElementById('invoiceTableBody').getElementsByTagName('tr');
            let totalLaborMaterial = 0;
            for (let row of rows) {
                const costCell = row.cells[1];
                const costInput = costCell.querySelector('input[type="number"]');
                totalLaborMaterial += parseValue(costInput ? costInput.value : '');
            }
            
            // Display Total Job Cost
            document.getElementById('totalJobCost').textContent = formatCurrency(totalLaborMaterial);
            
            const houseFeeAmount = (contractAmount * houseFeePercent) / 100;

            const afterHouseFee = contractAmount - houseFeeAmount;
            const netAmountDiff = contractAmount - netAmount;

            const totalAfterFees = afterHouseFee - netAmountDiff - totalLaborMaterial;
            document.getElementById('totalAfterFees').textContent = formatCurrency(totalAfterFees);

            // Calculate profit percentage for commission tiers - AFTER FEES √∑ CONTRACT AMOUNT
            const profitPercent = contractAmount > 0 ? (totalAfterFees / contractAmount) * 100 : 0;

            // Tiered rates based on profit percentage
            let vetRate = 25;
            if (profitPercent >= 50) vetRate = 55;
            else if (profitPercent >= 40) vetRate = 45;
            else if (profitPercent >= 33) vetRate = 35;

            let repRate = 20;
            if (profitPercent >= 50) repRate = 40;
            else if (profitPercent >= 40) repRate = 30;
            else if (profitPercent >= 33) repRate = 25;

            document.getElementById('vetRate').textContent = vetRate + '%';
            document.getElementById('repRate').textContent = repRate + '%';

            // Show/hide vet payout boxes based on number of vets
            if (numVets > 0) {
                document.getElementById('vetRateBox').style.display = 'block';
                document.getElementById('vetPayoutBox').style.display = 'block';
            } else {
                document.getElementById('vetRateBox').style.display = 'none';
                document.getElementById('vetPayoutBox').style.display = 'none';
            }

            // Show/hide rep rate box based on number of reps
            if (numReps > 0) {
                document.getElementById('repRateBox').style.display = 'block';
            } else {
                document.getElementById('repRateBox').style.display = 'none';
            }

            // Total salesmen (always vets + reps, regardless of PAR status)
            const totalSalesmen = numVets + numReps;
            
            // Calculate shared fees that ALL salespeople pay
            const totalPeople = numVets + numReps;
            const rideAlongFeePerPerson = totalPeople > 0 ? rideAlongFee / totalPeople : 0;
            const netAmountFeePerPerson = totalPeople > 0 ? netAmountDiff / totalPeople : 0;
            
            document.getElementById('rideAlongFeePerPerson').textContent = formatCurrency(rideAlongFeePerPerson);
            
            // VET CALCULATION - Always uses profit share divided by total salesmen
            const totalVetCommission = (totalAfterFees * vetRate) / 100;
            const perVetBeforeFees = totalSalesmen > 0 ? totalVetCommission / totalSalesmen : 0;
            const finalPerVet = perVetBeforeFees - rideAlongFeePerPerson;

            // REP CALCULATION - Depends on PAR status
            let finalPerRep = 0;
            
            if (activePAR === 'gutters') {
                // PAR GUTTERS calculation using adjusted amount
                const guttersLF = parseValue(document.getElementById('guttersLF').value);
                const woodLF = parseValue(document.getElementById('woodLF').value);
                
                const guttersTotal = guttersLF * 27;
                const woodTotal = woodLF * 17;
                
                // Calculate add-ons
                let addOnsTotal = 0;
                const addOnRows = document.getElementById('parAddOnsList').getElementsByClassName('par-addon-row');
                for (let row of addOnRows) {
                    const inputs = row.getElementsByTagName('input');
                    const select = row.getElementsByTagName('select')[0];
                    
                    const quantity = parseValue(inputs[1].value);
                    const rate = parseValue(inputs[2].value);
                    addOnsTotal += quantity * rate;
                }
                
                const parAmount = guttersTotal + woodTotal + addOnsTotal;
                
                // Display PAR amount (minimum the job should be sold for)
                document.getElementById('parGuttersAmount').textContent = formatCurrency(parAmount);
                
                // Calculate adjusted amount: Net + (Fees / 2)
                const totalFees = contractAmount - netAmount;
                const repHalfOfFees = totalFees / 2;
                const adjustedAmount = netAmount + repHalfOfFees;
                
                // Calculate payout: 10% of PAR + 50% of (adjusted - PAR)
                let parGuttersGross = 0;
                if (adjustedAmount >= parAmount) {
                    const basePay = parAmount * 0.10;
                    const overage = adjustedAmount - parAmount;
                    const overagePay = overage * 0.50;
                    parGuttersGross = basePay + overagePay;
                }
                
                // Divide by total salesmen
                const parPerPerson = totalSalesmen > 0 ? parGuttersGross / totalSalesmen : 0;
                
                // PAR rep only pays ride-along fee share (fees already handled in adjusted amount)
                finalPerRep = parPerPerson - rideAlongFeePerPerson;
                
                // Hide profit share rate box when PAR is active
                document.getElementById('repRateBox').style.display = 'none';
                
            } else if (activePAR === 'insulation') {
                // PAR INSULATION calculation using adjusted amount
                const insulationSF = parseValue(document.getElementById('insulationSF').value);
                const insulationWoodLF = parseValue(document.getElementById('insulationWoodLF').value);
                
                const insulationTotal = insulationSF * 4;
                const woodTotal = insulationWoodLF * 17;
                
                // Calculate add-ons
                let addOnsTotal = 0;
                const addOnRows = document.getElementById('parInsulationAddOnsList').getElementsByClassName('par-addon-row');
                for (let row of addOnRows) {
                    const inputs = row.getElementsByTagName('input');
                    const select = row.getElementsByTagName('select')[0];
                    
                    const quantity = parseValue(inputs[1].value);
                    const rate = parseValue(inputs[2].value);
                    addOnsTotal += quantity * rate;
                }
                
                const parAmount = insulationTotal + woodTotal + addOnsTotal;
                
                // Display PAR amount (minimum the job should be sold for)
                document.getElementById('parInsulationAmount').textContent = formatCurrency(parAmount);
                
                // Calculate adjusted amount: Net + (Fees / 2)
                const totalFees = contractAmount - netAmount;
                const repHalfOfFees = totalFees / 2;
                const adjustedAmount = netAmount + repHalfOfFees;
                
                // Calculate payout: 10% of PAR + 50% of (adjusted - PAR)
                let parInsulationGross = 0;
                if (adjustedAmount >= parAmount) {
                    const basePay = parAmount * 0.10;
                    const overage = adjustedAmount - parAmount;
                    const overagePay = overage * 0.50;
                    parInsulationGross = basePay + overagePay;
                }
                
                // Divide by total salesmen
                const parPerPerson = totalSalesmen > 0 ? parInsulationGross / totalSalesmen : 0;
                
                // PAR rep only pays ride-along fee share (fees already handled in adjusted amount)
                finalPerRep = parPerPerson - rideAlongFeePerPerson;
                
                // Hide profit share rate box when PAR is active
                document.getElementById('repRateBox').style.display = 'none';
                
            } else if (activePAR === 'coating') {
                // PAR COATING calculation using adjusted amount
                let parAmount = 0;
                
                // Calculate from all product rows
                const productRows = document.getElementById('parCoatingProductsList').querySelectorAll('.par-coating-row');
                productRows.forEach((row, index) => {
                    const select = row.querySelector('select');
                    const qtyInput = row.querySelector('.qty-input');
                    const calcDisplay = row.querySelector('.calc-display');
                    const customFields = row.nextElementSibling;
                    
                    if (select.value === 'custom|0' && customFields.classList.contains('active')) {
                        // Custom product
                        const inputs = customFields.querySelectorAll('input');
                        const customQty = parseValue(inputs[1].value);
                        const customRate = parseValue(inputs[2].value);
                        const customTotal = customQty * customRate;
                        parAmount += customTotal;
                        customFields.querySelector('.calc-display').textContent = formatCurrency(customTotal);
                    } else if (select.value) {
                        // Standard product
                        const [productKey, rate] = select.value.split('|');
                        const qty = parseValue(qtyInput.value);
                        const total = qty * parseFloat(rate);
                        parAmount += total;
                        calcDisplay.textContent = formatCurrency(total);
                    } else {
                        calcDisplay.textContent = '$0.00';
                    }
                });
                
                // Display PAR amount
                document.getElementById('parCoatingAmount').textContent = formatCurrency(parAmount);
                
                // Calculate adjusted amount: Net + (Fees / 2)
                const totalFees = contractAmount - netAmount;
                const repHalfOfFees = totalFees / 2;
                const adjustedAmount = netAmount + repHalfOfFees;
                
                // Calculate payout: 10% of PAR + 50% of (adjusted - PAR)
                let parCoatingGross = 0;
                if (adjustedAmount >= parAmount) {
                    const basePay = parAmount * 0.10;
                    const overage = adjustedAmount - parAmount;
                    const overagePay = overage * 0.50;
                    parCoatingGross = basePay + overagePay;
                }
                
                // Divide by total salesmen
                const parPerPerson = totalSalesmen > 0 ? parCoatingGross / totalSalesmen : 0;
                
                // PAR rep only pays ride-along fee share (fees already handled in adjusted amount)
                finalPerRep = parPerPerson - rideAlongFeePerPerson;
                
                // Hide profit share rate box when PAR is active
                document.getElementById('repRateBox').style.display = 'none';
                
            } else {
                // Standard profit share calculation
                const totalRepCommission = (totalAfterFees * repRate) / 100;
                const perRepBeforeFees = totalSalesmen > 0 ? totalRepCommission / totalSalesmen : 0;
                
                // Reps on profit share pay same fees as vets
                finalPerRep = perRepBeforeFees - rideAlongFeePerPerson - netAmountFeePerPerson;
                
                // Show profit share rate box when not on PAR
                if (numReps > 0) {
                    document.getElementById('repRateBox').style.display = 'block';
                }
            }

            document.getElementById('finalPerVet').textContent = formatCurrency(finalPerVet);
            document.getElementById('finalPerRep').textContent = formatCurrency(finalPerRep);

            // Ride along calculations
            const totalRideAlongPayout = rideAlongFee + rideAlongBonus;
            const perRideAlong = numRideAlongs > 0 ? totalRideAlongPayout / numRideAlongs : 0;

            document.getElementById('totalRideAlongPayout').textContent = formatCurrency(totalRideAlongPayout);
            document.getElementById('perRideAlong').textContent = formatCurrency(perRideAlong);

            // Update name fields with new amounts
            updateNameFields();

            // Generate calculation breakdown
            generateBreakdown();

            saveData();
        }

        function generateBreakdown() {
            const breakdownContent = document.getElementById('breakdownContent');
            const contractAmount = parseValue(document.getElementById('contractAmount').value);
            const netAmount = parseValue(document.getElementById('netAmount').value);
            const numVets = parseValue(document.getElementById('numVets').value);
            const numReps = parseValue(document.getElementById('numReps').value);
            const rideAlongFee = parseValue(document.getElementById('rideAlongFee').value);
            
            let html = '';
            
            // Check if we're using PAR for reps
            const usingPAR = activePAR !== null && numReps > 0;
            
            if (!usingPAR && numVets > 0) {
                // PROFIT SHARE BREAKDOWN - Show full calculation
                const totalFees = contractAmount - netAmount;
                const houseFeePercent = contractAmount <= 20000 ? 10 : contractAmount <= 30000 ? 9 : 8;
                const houseFeeAmount = (contractAmount * houseFeePercent) / 100;
                
                // Calculate job cost
                const rows = document.getElementById('invoiceTableBody').getElementsByTagName('tr');
                let totalLaborMaterial = 0;
                for (let row of rows) {
                    const costCell = row.cells[1];
                    const costInput = costCell.querySelector('input[type="number"]');
                    totalLaborMaterial += parseValue(costInput ? costInput.value : '');
                }
                
                const afterHouseFee = contractAmount - houseFeeAmount;
                const netAmountDiff = contractAmount - netAmount;
                const afterFeesFromContract = afterHouseFee - netAmountDiff;
                const totalAfterFees = afterFeesFromContract - totalLaborMaterial;
                const profitPercent = contractAmount > 0 ? (totalAfterFees / contractAmount) * 100 : 0;
                
                html += '<div class="breakdown-section">';
                html += '<div class="breakdown-section-title">CONTRACT & FEES</div>';
                html += `<div class="breakdown-line"><span>Contract Amount:</span><span>${formatCurrency(contractAmount)}</span></div>`;
                html += `<div class="breakdown-line"><span>- House Fee (${houseFeePercent}%):</span><span>-${formatCurrency(houseFeeAmount)}</span></div>`;
                html += `<div class="breakdown-line"><span>= After House Fee:</span><span>${formatCurrency(afterHouseFee)}</span></div>`;
                html += `<div class="breakdown-line"><span>- Fees (Contract - Net):</span><span>-${formatCurrency(netAmountDiff)}</span></div>`;
                html += `<div class="breakdown-line"><span>= After Fees from Contract:</span><span>${formatCurrency(afterFeesFromContract)}</span></div>`;
                html += `<div class="breakdown-line"><span>- Job Cost (Labor & Materials):</span><span>-${formatCurrency(totalLaborMaterial)}</span></div>`;
                html += `<div class="breakdown-line total"><span>= After All Fees (Profit Pool):</span><span>${formatCurrency(totalAfterFees)}</span></div>`;
                html += `<div class="breakdown-line total"><span>Profit Percentage:</span><span>${profitPercent.toFixed(2)}%</span></div>`;
                html += '</div>';
                
                // VET CALCULATION
                if (numVets > 0) {
                    let vetRate = 25;
                    if (profitPercent >= 50) vetRate = 55;
                    else if (profitPercent >= 40) vetRate = 45;
                    else if (profitPercent >= 33) vetRate = 35;
                    
                    const totalSalesmen = numVets + numReps;
                    const totalVetCommission = (totalAfterFees * vetRate) / 100;
                    const perVetBeforeFees = totalSalesmen > 0 ? totalVetCommission / totalSalesmen : 0;
                    const totalPeople = numVets + numReps;
                    const rideAlongFeePerPerson = totalPeople > 0 ? rideAlongFee / totalPeople : 0;
                    const netAmountFeePerPerson = totalPeople > 0 ? netAmountDiff / totalPeople : 0;
                    const finalPerVet = perVetBeforeFees - rideAlongFeePerPerson - netAmountFeePerPerson;
                    
                    html += '<div class="breakdown-section">';
                    html += '<div class="breakdown-section-title">VET PAYOUT (PROFIT SHARE)</div>';
                    html += `<div class="breakdown-line"><span>Profit Pool (After All Fees):</span><span>${formatCurrency(totalAfterFees)}</span></div>`;
                    html += `<div class="breakdown-line"><span>Vet Rate (based on ${profitPercent.toFixed(2)}% profit):</span><span>${vetRate}%</span></div>`;
                    html += `<div class="breakdown-line"><span>Total Vet Commission:</span><span>${formatCurrency(totalVetCommission)}</span></div>`;
                    html += `<div class="breakdown-line"><span>√∑ Total Salesmen (${totalSalesmen}):</span><span>${formatCurrency(perVetBeforeFees)}</span></div>`;
                    html += `<div class="breakdown-line"><span>- Ride Along Fee Share:</span><span>-${formatCurrency(rideAlongFeePerPerson)}</span></div>`;
                    html += `<div class="breakdown-line"><span>- Net Amount Fee Share:</span><span>-${formatCurrency(netAmountFeePerPerson)}</span></div>`;
                    html += `<div class="breakdown-line total"><span>Final Per Vet:</span><span>${formatCurrency(finalPerVet)}</span></div>`;
                    html += '</div>';
                }
                
                // REP PROFIT SHARE
                if (numReps > 0 && !usingPAR) {
                    let repRate = 20;
                    if (profitPercent >= 50) repRate = 40;
                    else if (profitPercent >= 40) repRate = 30;
                    else if (profitPercent >= 33) repRate = 25;
                    
                    const totalSalesmen = numVets + numReps;
                    const totalRepCommission = (totalAfterFees * repRate) / 100;
                    const perRepBeforeFees = totalSalesmen > 0 ? totalRepCommission / totalSalesmen : 0;
                    const totalPeople = numVets + numReps;
                    const rideAlongFeePerPerson = totalPeople > 0 ? rideAlongFee / totalPeople : 0;
                    const netAmountFeePerPerson = totalPeople > 0 ? netAmountDiff / totalPeople : 0;
                    const finalPerRep = perRepBeforeFees - rideAlongFeePerPerson - netAmountFeePerPerson;
                    
                    html += '<div class="breakdown-section">';
                    html += '<div class="breakdown-section-title">REP PAYOUT (PROFIT SHARE)</div>';
                    html += `<div class="breakdown-line"><span>Profit Pool (After All Fees):</span><span>${formatCurrency(totalAfterFees)}</span></div>`;
                    html += `<div class="breakdown-line"><span>Rep Rate (based on ${profitPercent.toFixed(2)}% profit):</span><span>${repRate}%</span></div>`;
                    html += `<div class="breakdown-line"><span>Total Rep Commission:</span><span>${formatCurrency(totalRepCommission)}</span></div>`;
                    html += `<div class="breakdown-line"><span>√∑ Total Salesmen (${totalSalesmen}):</span><span>${formatCurrency(perRepBeforeFees)}</span></div>`;
                    html += `<div class="breakdown-line"><span>- Ride Along Fee Share:</span><span>-${formatCurrency(rideAlongFeePerPerson)}</span></div>`;
                    html += `<div class="breakdown-line"><span>- Net Amount Fee Share:</span><span>-${formatCurrency(netAmountFeePerPerson)}</span></div>`;
                    html += `<div class="breakdown-line total"><span>Final Per Rep:</span><span>${formatCurrency(finalPerRep)}</span></div>`;
                    html += '</div>';
                }
            }
            
            // PAR BREAKDOWN - Only show relevant info
            if (usingPAR) {
                const totalFees = contractAmount - netAmount;
                
                html += '<div class="breakdown-section">';
                html += '<div class="breakdown-section-title">CONTRACT INFORMATION</div>';
                html += `<div class="breakdown-line"><span>Contract Amount:</span><span>${formatCurrency(contractAmount)}</span></div>`;
                html += `<div class="breakdown-line"><span>Net Amount:</span><span>${formatCurrency(netAmount)}</span></div>`;
                html += `<div class="breakdown-line total"><span>Total Fees (Contract - Net):</span><span>${formatCurrency(totalFees)}</span></div>`;
                html += '</div>';
                
                if (activePAR === 'gutters') {
                    const guttersLF = parseValue(document.getElementById('guttersLF').value);
                    const woodLF = parseValue(document.getElementById('woodLF').value);
                    const guttersTotal = guttersLF * 27;
                    const woodTotal = woodLF * 17;
                    
                    let addOnsTotal = 0;
                    const addOnRows = document.getElementById('parAddOnsList').getElementsByClassName('par-addon-row');
                    for (let row of addOnRows) {
                        const inputs = row.getElementsByTagName('input');
                        const quantity = parseValue(inputs[1].value);
                        const rate = parseValue(inputs[2].value);
                        addOnsTotal += quantity * rate;
                    }
                    
                    const parAmount = guttersTotal + woodTotal + addOnsTotal;
                    const repHalfOfFees = totalFees / 2;
                    const adjustedAmount = netAmount + repHalfOfFees;
                    
                    html += '<div class="breakdown-section">';
                    html += '<div class="breakdown-section-title">REP PAYOUT (PAR GUTTERS)</div>';
                    html += `<div class="breakdown-line"><span>Gutters (${guttersLF} lf √ó $27):</span><span>${formatCurrency(guttersTotal)}</span></div>`;
                    html += `<div class="breakdown-line"><span>Wood (${woodLF} lf √ó $17):</span><span>${formatCurrency(woodTotal)}</span></div>`;
                    if (addOnsTotal > 0) {
                        html += `<div class="breakdown-line"><span>Add-ons:</span><span>${formatCurrency(addOnsTotal)}</span></div>`;
                    }
                    html += `<div class="breakdown-line total"><span>Total PAR:</span><span>${formatCurrency(parAmount)}</span></div>`;
                    html += `<div class="breakdown-line"><span>Net Amount:</span><span>${formatCurrency(netAmount)}</span></div>`;
                    html += `<div class="breakdown-line"><span>+ Rep Half of Fees (${formatCurrency(totalFees)} √∑ 2):</span><span>+${formatCurrency(repHalfOfFees)}</span></div>`;
                    html += `<div class="breakdown-line total"><span>Adjusted Amount:</span><span>${formatCurrency(adjustedAmount)}</span></div>`;
                    
                    if (adjustedAmount >= parAmount) {
                        const basePay = parAmount * 0.10;
                        const overage = adjustedAmount - parAmount;
                        const overagePay = overage * 0.50;
                        const gross = basePay + overagePay;
                        const totalSalesmen = numVets + numReps;
                        const perPerson = totalSalesmen > 0 ? gross / totalSalesmen : 0;
                        const totalPeople = numVets + numReps;
                        const rideAlongFeePerPerson = totalPeople > 0 ? rideAlongFee / totalPeople : 0;
                        const finalPayout = perPerson - rideAlongFeePerPerson;
                        
                        html += `<div class="breakdown-line"><span>Base Pay (10% of PAR):</span><span>${formatCurrency(basePay)}</span></div>`;
                        html += `<div class="breakdown-line"><span>Overage (${formatCurrency(adjustedAmount)} - ${formatCurrency(parAmount)}):</span><span>${formatCurrency(overage)}</span></div>`;
                        html += `<div class="breakdown-line"><span>Overage Pay (50%):</span><span>${formatCurrency(overagePay)}</span></div>`;
                        html += `<div class="breakdown-line"><span>Gross Payout:</span><span>${formatCurrency(gross)}</span></div>`;
                        html += `<div class="breakdown-line"><span>√∑ Total Salesmen (${totalSalesmen}):</span><span>${formatCurrency(perPerson)}</span></div>`;
                        html += `<div class="breakdown-line"><span>- Ride Along Fee Share:</span><span>-${formatCurrency(rideAlongFeePerPerson)}</span></div>`;
                        html += `<div class="breakdown-line total"><span>Final Per Rep:</span><span>${formatCurrency(finalPayout)}</span></div>`;
                    } else {
                        html += `<div class="breakdown-line total"><span>Final Per Rep:</span><span>$0.00 (Sold below PAR)</span></div>`;
                    }
                    html += '</div>';
                }
            }
            
            breakdownContent.innerHTML = html;
        }

        function saveData() {
            const data = {
                customerName: document.getElementById('customerName').value,
                jobNumber: document.getElementById('jobNumber').value,
                moneyInBank: document.getElementById('moneyInBank').value,
                contractAmount: document.getElementById('contractAmount').value,
                netAmount: document.getElementById('netAmount').value,
                rideAlongFee: document.getElementById('rideAlongFee').value,
                rideAlongBonus: document.getElementById('rideAlongBonus').value,
                numVets: document.getElementById('numVets').value,
                numReps: document.getElementById('numReps').value,
                numRideAlongs: document.getElementById('numRideAlongs').value,
                activePAR: activePAR,
                guttersLF: document.getElementById('guttersLF').value,
                woodLF: document.getElementById('woodLF').value,
                insulationSF: document.getElementById('insulationSF').value,
                insulationWoodLF: document.getElementById('insulationWoodLF').value,
                vetNames: Array.from(document.getElementById('vetNamesList').querySelectorAll('input')).map(i => i.value),
                repNames: Array.from(document.getElementById('repNamesList').querySelectorAll('input')).map(i => i.value),
                rideAlongNames: Array.from(document.getElementById('rideAlongNamesList').querySelectorAll('input')).map(i => i.value),
                rows: []
            };

            const rows = document.getElementById('invoiceTableBody').getElementsByTagName('tr');
            for (let row of rows) {
                const costCell = row.cells[1];
                const costInput = costCell.querySelector('input[type="number"]');
                data.rows.push({
                    laborMaterial: row.cells[0].getElementsByTagName('input')[0].value,
                    cost: costInput ? costInput.value : '',
                    paid: row.cells[2].getElementsByTagName('input')[0].checked
                });
            }

            localStorage.setItem('invoiceSheetData', JSON.stringify(data));
        }

        function loadData() {
            // Always start with clear fields
            initializeTable();
        }

        function printInvoice() {
            window.print();
        }

        function addNewFile() {
            if (confirm('Create a new invoice sheet?')) {
                localStorage.removeItem('invoiceSheetData');
                location.reload();
            }
        }

        // Event listeners
        document.getElementById('customerName').addEventListener('input', saveData);
        document.getElementById('jobNumber').addEventListener('input', saveData);
        document.getElementById('moneyInBank').addEventListener('input', saveData);
        document.getElementById('contractAmount').addEventListener('input', updateCalculations);
        document.getElementById('netAmount').addEventListener('input', updateCalculations);
        document.getElementById('rideAlongFee').addEventListener('input', updateCalculations);
        document.getElementById('rideAlongBonus').addEventListener('input', updateCalculations);
        document.getElementById('guttersLF').addEventListener('input', updateCalculations);
        document.getElementById('woodLF').addEventListener('input', updateCalculations);
        document.getElementById('insulationSF').addEventListener('input', updateCalculations);
        document.getElementById('insulationWoodLF').addEventListener('input', updateCalculations);
        
        document.getElementById('numVets').addEventListener('input', () => {
            updateNameFields();
            updateCalculations();
        });
        document.getElementById('numReps').addEventListener('input', () => {
            updateNameFields();
            updateCalculations();
        });
        document.getElementById('numRideAlongs').addEventListener('input', () => {
            updateNameFields();
            updateCalculations();
        });

        window.addEventListener('load', loadData);
    </script>
</body>
</html>
